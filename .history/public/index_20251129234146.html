<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Accesorios Frices - Auth</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="auth-wrapper">

  <!-- LOGO -->
  <img src="logo.png" class="logo-frices" alt="Accesorios Frices">

  <!-- MENSAJE GLOBAL -->
  <div id="message" class="auth-msg-global"></div>

  <!-- TARJETA LOGIN / REGISTER -->
  <div id="auth-card" class="auth-card">
    <div class="auth-tabs">
      <button id="tab-login" class="tab active" onclick="showLogin()">Login</button>
      <button id="tab-register" class="tab" onclick="showRegister()">Register</button>
    </div>

    <!-- LOGIN -->
    <div id="login-form" class="form-panel active">
      <h2 class="auth-title">Iniciar Sesi√≥n</h2>

      <input id="log-email" class="auth-input" placeholder="Correo" type="email" />
      <input id="log-pass" class="auth-input" placeholder="Contrase√±a" type="password" />

      <button class="auth-button" onclick="login()">Login</button>
      <div id="msg-login" class="auth-msg"></div>

      <button class="link-button" type="button">¬øOlvidaste tu contrase√±a?</button>

      <p class="switch">
        ¬øA√∫n no tienes cuenta?
        <button type="button" class="link-button" onclick="showRegister()">Crear cuenta</button>
      </p>
    </div>

    <!-- REGISTER -->
    <div id="register-form" class="form-panel">
      <h2 class="auth-title">Crear Cuenta</h2>

      <input id="reg-nombre" class="auth-input" placeholder="Nombre completo" />
      <input id="reg-email" class="auth-input" placeholder="Correo" type="email" />
      <input id="reg-pass" class="auth-input" placeholder="Contrase√±a" type="password" />

      <button class="auth-button" onclick="registrar()">Registrarse</button>
      <div id="msg-registro" class="auth-msg"></div>

      <p class="switch">
        ¬øYa tienes una cuenta?
        <button type="button" class="link-button" onclick="showLogin()">Iniciar sesi√≥n</button>
      </p>
    </div>
  </div>

  <!-- SECCI√ìN BIENVENIDA -->
  <div id="welcomeSection" class="auth-card card-welcome" style="display:none;">
    <div class="welcome-icon">üíç</div>
    <h2 class="welcome-title">Bienvenida a Accesorios Frices</h2>
    <p id="welcomeText" class="welcome-text"></p>
    <p class="welcome-subtext">
      Tu sesi√≥n se ha iniciado correctamente.  
      Pr√≥ximamente podr√°s ver tus pedidos, direcciones y favoritos desde aqu√≠.
    </p>
    <button id="logoutBtn" class="auth-button secondary">Cerrar sesi√≥n</button>
  </div>

</div>

<script>
  const API_URL = "http://localhost:3000/api";
  const $ = (id) => document.getElementById(id);

  function clearMessages() {
    $("message").innerText = "";
    $("msg-login").innerText = "";
    $("msg-registro").innerText = "";
  }

  function showLogin() {
    clearMessages();
    $("login-form").classList.add("active");
    $("register-form").classList.remove("active");
    $("tab-login").classList.add("active");
    $("tab-register").classList.remove("active");
  }

  function showRegister() {
    clearMessages();
    $("login-form").classList.remove("active");
    $("register-form").classList.add("active");
    $("tab-login").classList.remove("active");
    $("tab-register").classList.add("active");
  }

  // ===== VALIDACIONES FRONTEND =====
  function validarEmail(correo) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo);
  }

  // ============ REGISTRO ============
  async function registrar() {
    clearMessages();

    const nombre = $("reg-nombre").value.trim();
    const email  = $("reg-email").value.trim();
    const pass   = $("reg-pass").value.trim();

    // ===== Validaciones =====
    if (!nombre || !email || !pass) {
      $("msg-registro").innerText = "‚ö†Ô∏è Completa todos los campos.";
      return;
    }

    if (!validarEmail(email)) {
      $("msg-registro").innerText = "‚ö†Ô∏è El correo no es v√°lido.";
      return;
    }

    if (pass.length < 8) {
      $("msg-registro").innerText = "‚ö†Ô∏è La contrase√±a debe tener m√≠nimo 8 caracteres.";
      return;
    }

    try {
      const res = await fetch(`${API_URL}/auth/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, email, password: pass }),
      });

      const data = await res.json();

      if (!res.ok) {
        // ===== Mensajes del backend =====
        if (data.message?.includes("registrado")) {
          $("msg-registro").innerText = "‚ö†Ô∏è Este correo ya est√° registrado. Intenta iniciar sesi√≥n.";
        } else {
          $("msg-registro").innerText = data.message || "‚ö†Ô∏è Error al registrar.";
        }
        return;
      }

      // ===== Registro exitoso =====
      $("msg-registro").innerText = "üéâ Registro exitoso. Ahora inicia sesi√≥n.";
      showLogin();
      $("log-email").value = email;

    } catch (err) {
      console.error(err);
      $("message").innerText = "‚ùå Error de red al registrar.";
    }
  }

  // ============ LOGIN ============
  async function login() {
    clearMessages();

    const email = $("log-email").value.trim();
    const pass  = $("log-pass").value.trim();

    // ===== Validaciones =====
    if (!email || !pass) {
      $("msg-login").innerText = "‚ö†Ô∏è Ingresa correo y contrase√±a.";
      return;
    }

    if (!validarEmail(email)) {
      $("msg-login").innerText = "‚ö†Ô∏è El correo no es v√°lido.";
      return;
    }

    try {
      const res = await fetch(`${API_URL}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: pass }),
      });

      const data = await res.json();

      if (!res.ok) {
        // ===== Errores del backend
        if (data.message?.includes("Credenciales")) {
          $("msg-login").innerText = "‚ùå Correo o contrase√±a incorrectos.";
        } else {
          $("msg-login").innerText = data.message || "‚ùå Error al iniciar sesi√≥n.";
        }
        return;
      }

      // ===== Login exitoso =====
      if (data.token) {
        localStorage.setItem("frices_token", data.token);
      }

      const userName = data.user?.nombre || email;
      $("welcomeText").innerText = `Hola, ${userName}. Gracias por confiar en Accesorios Frices.`;

      $("auth-card").style.display = "none";
      $("welcomeSection").style.display = "block";

    } catch (err) {
      console.error(err);
      $("message").innerText = "‚ùå Error de red al iniciar sesi√≥n.";
    }
  }

  // ============ LOGOUT ============
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("frices_token");
      $("welcomeSection").style.display = "none";
      $("auth-card").style.display = "block";
      showLogin();
    });
  }
</script>

</body>
</html>√ë
